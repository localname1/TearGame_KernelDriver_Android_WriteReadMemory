#!/bin/bash
# ============================================================================
# æ³ªå¿ƒå¼€æºé©±åŠ¨ - TearGame Open Source Driver
# ============================================================================
# ä½œè€… (Author): æ³ªå¿ƒ (Tear)
# QQ: 2254013571
# é‚®ç®± (Email): tearhacker@outlook.com
# ç”µæŠ¥ (Telegram): t.me/TearGame
# GitHub: github.com/tearhacker
# ============================================================================
# æœ¬é¡¹ç›®å®Œå…¨å…è´¹å¼€æºï¼Œä»£ç æ˜æ–‡å…¬å¼€
# This project is completely free and open source with clear code
# 
# ç¦æ­¢ç”¨äºå¼•æµç›ˆåˆ©ï¼Œä¿ç•™å¼€æºç‰ˆæƒæ‰€æœ‰
# Commercial use for profit is prohibited, all open source rights reserved
# 
# å‡¡æ˜¯æ¶æ„ç›ˆåˆ©è€…éœ€æ‰¿æ‹…æ³•å¾‹è´£ä»»
# Those who maliciously profit will bear legal responsibility
# ============================================================================
# Kernel_driver_hack æ¸…ç©ºå…¨éƒ¨ç¼–è¯‘å¹¶é‡æ–°ç¼–è¯‘è„šæœ¬
# ============================================================================
# ç‰ˆæœ¬: 1.0
# åŠŸèƒ½: æ¸…ç©ºæ‰€æœ‰ç¼–è¯‘äº§ç‰©ï¼Œç„¶åæ‰§è¡Œå®Œæ•´çš„é‡æ–°ç¼–è¯‘
# ============================================================================

set -e

# ============================================================================
# é¢œè‰²å®šä¹‰
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# ============================================================================
# è·¯å¾„é…ç½®
# ============================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KERNEL_ROOT="$SCRIPT_DIR/android13-5.15-2024-11"
KERNEL_SRC="$KERNEL_ROOT/common"
DRIVER_SRC="$KERNEL_ROOT/hello_world_moduleBY515"
OUTPUT_DIR="$SCRIPT_DIR/out_kernel_hack_v5"

# ============================================================================
# æ—¥å¿—å‡½æ•°
# ============================================================================
log() {
    local level=$1
    shift
    local message="$*"
    
    case $level in
        "INFO")    echo -e "${CYAN}â„¹ï¸  $message${NC}" ;;
        "WARN")    echo -e "${YELLOW}âš ï¸  $message${NC}" ;;
        "ERROR")   echo -e "${RED}âŒ $message${NC}" ;;
        "SUCCESS") echo -e "${GREEN}âœ… $message${NC}" ;;
        "STEP")    echo -e "\n${BOLD}${BLUE}ğŸ”§ $message${NC}\n" ;;
    esac
}

# ============================================================================
# æ˜¾ç¤ºæ¨ªå¹…
# ============================================================================
show_banner() {
    echo -e "${BOLD}${CYAN}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  Kernel_driver_hack æ¸…ç©ºå…¨éƒ¨ç¼–è¯‘å¹¶é‡æ–°ç¼–è¯‘è„šæœ¬"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${NC}\n"
}

# ============================================================================
# æ¸…ç©ºå†…æ ¸ç¼–è¯‘äº§ç‰©
# ============================================================================
clean_kernel() {
    log "STEP" "æ¸…ç©ºå†…æ ¸ç¼–è¯‘äº§ç‰©"
    
    if [ -d "$KERNEL_SRC" ]; then
        cd "$KERNEL_SRC"
        
        log "INFO" "æ‰§è¡Œ make mrproper (å®Œå…¨æ¸…ç†)..."
        make mrproper 2>/dev/null || true
        
        log "INFO" "åˆ é™¤é¢å¤–çš„ç¼–è¯‘æ–‡ä»¶..."
        rm -f .config .config.old 2>/dev/null || true
        rm -f Module.symvers modules.order 2>/dev/null || true
        rm -f vmlinux System.map 2>/dev/null || true
        rm -rf .tmp_* 2>/dev/null || true
        rm -f *.o *.ko *.mod.c *.mod 2>/dev/null || true
        
        # æ¸…ç†æ‰€æœ‰ .o å’Œ .cmd æ–‡ä»¶
        find . -name "*.o" -type f -delete 2>/dev/null || true
        find . -name "*.ko" -type f -delete 2>/dev/null || true
        find . -name "*.mod" -type f -delete 2>/dev/null || true
        find . -name "*.mod.c" -type f -delete 2>/dev/null || true
        find . -name ".*.cmd" -type f -delete 2>/dev/null || true
        find . -name "*.order" -type f -delete 2>/dev/null || true
        find . -name "*.symvers" -type f -delete 2>/dev/null || true
        find . -name "built-in.a" -type f -delete 2>/dev/null || true
        
        log "SUCCESS" "å†…æ ¸ç¼–è¯‘äº§ç‰©å·²æ¸…ç©º"
    else
        log "WARN" "å†…æ ¸æºç ç›®å½•ä¸å­˜åœ¨: $KERNEL_SRC"
    fi
}

# ============================================================================
# æ¸…ç©ºé©±åŠ¨ç¼–è¯‘äº§ç‰©
# ============================================================================
clean_driver() {
    log "STEP" "æ¸…ç©ºé©±åŠ¨ç¼–è¯‘äº§ç‰©"
    
    if [ -d "$DRIVER_SRC" ]; then
        cd "$DRIVER_SRC"
        
        log "INFO" "æ¸…ç†é©±åŠ¨ç›®å½•..."
        rm -f *.o *.ko *.mod.c *.mod *.order *.symvers 2>/dev/null || true
        rm -f .*.cmd 2>/dev/null || true
        rm -rf .tmp_versions 2>/dev/null || true
        
        # æ¢å¤åŸå§‹ Makefile (å¦‚æœæœ‰å¤‡ä»½)
        if [ -f "Makefile.original" ]; then
            log "INFO" "æ¢å¤åŸå§‹ Makefile..."
            cp Makefile.original Makefile
        fi
        
        log "SUCCESS" "é©±åŠ¨ç¼–è¯‘äº§ç‰©å·²æ¸…ç©º"
    else
        log "WARN" "é©±åŠ¨æºç ç›®å½•ä¸å­˜åœ¨: $DRIVER_SRC"
    fi
}

# ============================================================================
# æ¸…ç©ºè¾“å‡ºç›®å½•
# ============================================================================
clean_output() {
    log "STEP" "æ¸…ç©ºè¾“å‡ºç›®å½•"
    
    if [ -d "$OUTPUT_DIR" ]; then
        log "INFO" "åˆ é™¤è¾“å‡ºç›®å½•: $OUTPUT_DIR"
        rm -rf "$OUTPUT_DIR"
        log "SUCCESS" "è¾“å‡ºç›®å½•å·²æ¸…ç©º"
    else
        log "INFO" "è¾“å‡ºç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
    fi
}

# ============================================================================
# æ¸…ç©ºç¼–è¯‘çŠ¶æ€å’Œæ—¥å¿—
# ============================================================================
clean_state() {
    log "STEP" "æ¸…ç©ºç¼–è¯‘çŠ¶æ€å’Œæ—¥å¿—"
    
    cd "$SCRIPT_DIR"
    
    # åˆ é™¤çŠ¶æ€æ–‡ä»¶
    rm -f .build_state 2>/dev/null || true
    
    # åˆ é™¤æ—§çš„ç¼–è¯‘æ—¥å¿— (ä¿ç•™æœ€è¿‘ 3 ä¸ª)
    log "INFO" "æ¸…ç†æ—§çš„ç¼–è¯‘æ—¥å¿—..."
    ls -t build_*.log 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true
    
    log "SUCCESS" "ç¼–è¯‘çŠ¶æ€å’Œæ—§æ—¥å¿—å·²æ¸…ç©º"
}

# ============================================================================
# æ¸…ç©ºå…¶ä»–è¾“å‡ºç›®å½•
# ============================================================================
clean_other_outputs() {
    log "STEP" "æ¸…ç©ºå…¶ä»–è¾“å‡ºç›®å½•"
    
    cd "$SCRIPT_DIR"
    
    # æ¸…ç†å…¶ä»–å¯èƒ½çš„è¾“å‡ºç›®å½•
    local OTHER_DIRS=(
        "out"
        "out_kernel_hack"
        "out_kernel_hack_v2"
        "out_kernel_hack_v3"
        "out_kernel_hack_v4"
    )
    
    for dir in "${OTHER_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            log "INFO" "åˆ é™¤: $dir"
            rm -rf "$dir"
        fi
    done
    
    log "SUCCESS" "å…¶ä»–è¾“å‡ºç›®å½•å·²æ¸…ç©º"
}

# ============================================================================
# æ˜¾ç¤ºæ¸…ç†æ‘˜è¦
# ============================================================================
show_summary() {
    echo -e "\n${BOLD}${GREEN}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  âœ… æ¸…ç†å®Œæˆï¼"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${NC}\n"
    
    echo -e "${CYAN}å·²æ¸…ç†çš„å†…å®¹:${NC}"
    echo "  â€¢ å†…æ ¸ç¼–è¯‘äº§ç‰© (make mrproper)"
    echo "  â€¢ é©±åŠ¨ç¼–è¯‘äº§ç‰© (.o, .ko, .mod ç­‰)"
    echo "  â€¢ è¾“å‡ºç›®å½• (out_kernel_hack_v5)"
    echo "  â€¢ ç¼–è¯‘çŠ¶æ€æ–‡ä»¶ (.build_state)"
    echo "  â€¢ æ—§çš„ç¼–è¯‘æ—¥å¿—"
    echo ""
}

# ============================================================================
# æ‰§è¡Œé‡æ–°ç¼–è¯‘
# ============================================================================
rebuild() {
    log "STEP" "å¼€å§‹é‡æ–°ç¼–è¯‘"
    
    cd "$SCRIPT_DIR"
    
    if [ -f "compile_kernel_hack_v4.sh" ]; then
        log "INFO" "æ‰§è¡Œ compile_kernel_hack_v4.sh -f (å¼ºåˆ¶é‡ç¼–)..."
        echo ""
        bash compile_kernel_hack_v4.sh -f
    else
        log "ERROR" "ç¼–è¯‘è„šæœ¬ä¸å­˜åœ¨: compile_kernel_hack_v4.sh"
        exit 1
    fi
}

# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================
main() {
    show_banner
    
    local start_time=$(date +%s)
    
    # è¯¢é—®ç¡®è®¤
    echo -e "${YELLOW}âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰ç¼–è¯‘äº§ç‰©å¹¶é‡æ–°ç¼–è¯‘ï¼${NC}"
    echo -e "${YELLOW}   è¿™å¯èƒ½éœ€è¦ 30-60 åˆ†é’Ÿå®Œæˆã€‚${NC}"
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ -y å‚æ•°è·³è¿‡ç¡®è®¤
    if [[ "$1" != "-y" && "$1" != "--yes" ]]; then
        read -p "æ˜¯å¦ç»§ç»­? [y/N] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log "INFO" "æ“ä½œå·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    echo ""
    
    # æ‰§è¡Œæ¸…ç†
    clean_kernel
    clean_driver
    clean_output
    clean_other_outputs
    clean_state
    
    show_summary
    
    # è¯¢é—®æ˜¯å¦ç«‹å³é‡æ–°ç¼–è¯‘
    if [[ "$1" != "-y" && "$1" != "--yes" ]]; then
        read -p "æ˜¯å¦ç«‹å³å¼€å§‹é‡æ–°ç¼–è¯‘? [Y/n] " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            log "INFO" "æ¸…ç†å®Œæˆï¼Œè·³è¿‡é‡æ–°ç¼–è¯‘"
            echo -e "\n${CYAN}æ‰‹åŠ¨ç¼–è¯‘å‘½ä»¤:${NC}"
            echo "  cd $SCRIPT_DIR"
            echo "  ./compile_kernel_hack_v4.sh -f"
            exit 0
        fi
    fi
    
    # æ‰§è¡Œé‡æ–°ç¼–è¯‘
    rebuild
    
    local end_time=$(date +%s)
    local total_time=$((end_time - start_time))
    local minutes=$((total_time / 60))
    local seconds=$((total_time % 60))
    
    echo -e "\n${BOLD}${GREEN}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  ğŸ‰ æ¸…ç©ºå¹¶é‡æ–°ç¼–è¯‘å®Œæˆï¼æ€»è€—æ—¶: ${minutes}åˆ†${seconds}ç§’"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${NC}"
}

# ============================================================================
# å¸®åŠ©ä¿¡æ¯
# ============================================================================
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -y, --yes    è·³è¿‡ç¡®è®¤æç¤ºï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†å’Œé‡ç¼–"
    echo "  -h, --help   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "åŠŸèƒ½:"
    echo "  1. æ¸…ç©ºå†…æ ¸ç¼–è¯‘äº§ç‰© (make mrproper)"
    echo "  2. æ¸…ç©ºé©±åŠ¨ç¼–è¯‘äº§ç‰©"
    echo "  3. æ¸…ç©ºè¾“å‡ºç›®å½•"
    echo "  4. æ¸…ç©ºç¼–è¯‘çŠ¶æ€å’Œæ—§æ—¥å¿—"
    echo "  5. æ‰§è¡Œå®Œæ•´çš„é‡æ–°ç¼–è¯‘"
    exit 0
fi

main "$@"
